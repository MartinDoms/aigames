<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head(jsRoot='admin-add-template')}">
    <!-- Head content will be replaced by the fragment -->
</head>

<body class="bg-neutral min-h-screen flex flex-col">

<nav th:replace="~{fragments/nav :: nav}"></nav>

<div class="container mx-auto px-4 py-6 flex-grow">
    <div class="max-w-5xl mx-auto"
         x-data="addRoundTemplate()"
         x-init="init()">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-primary">Add New Round Template</h1>
            <p class="text-primary-dark">Create a new round template from a YouTube video</p>
        </div>

        <!-- Form Section -->
        <div class="bg-neutral-light p-6 rounded-lg shadow-md border border-neutral-dark mb-8">
            <form @submit.prevent="saveTemplate()" class="space-y-6">
                <!-- YouTube URL Input -->
                <div>
                    <label for="youtubeUrl" class="block text-primary font-medium mb-2">YouTube URL</label>
                    <div class="flex">
                        <input
                                id="youtubeUrl"
                                type="text"
                                x-model="youtubeUrl"
                                @input="processYoutubeUrl()"
                                placeholder="https://www.youtube.com/watch?v=..."
                                class="flex-grow px-4 py-2 rounded-l-md border border-neutral-dark bg-neutral focus:outline-none focus:ring-2 focus:ring-primary"
                        >
                        <button
                                type="button"
                                @click="processYoutubeUrl(true)"
                                class="px-4 py-2 bg-secondary hover:bg-secondary-dark text-primary-dark rounded-r-md border-t border-r border-b border-neutral-dark"
                        >
                            Load Preview
                        </button>
                    </div>
                    <p class="text-red-500 text-sm mt-1" x-show="errors.youtubeUrl" x-text="errors.youtubeUrl"></p>
                </div>

                <!-- Video Preview Section -->
                <div x-show="youtubeVideoId" class="border border-neutral-dark rounded-lg overflow-hidden">
                    <div class="bg-primary text-neutral p-3">
                        <h3 class="font-semibold">Video Preview</h3>
                    </div>
                    <div class="aspect-video bg-black">
                        <div :id="'youtube-player'" class="w-full h-full"></div>
                    </div>
                    <div class="p-4 bg-neutral flex gap-4">
                        <div>
                            <label for="startTime" class="block text-primary-dark text-sm mb-1">Start Time (seconds)</label>
                            <input
                                    id="startTime"
                                    type="number"
                                    x-model="startTime"
                                    min="0"
                                    :max="videoLength || 0"
                                    class="w-full px-3 py-2 rounded border border-neutral-dark bg-neutral-light"
                            >
                        </div>
                        <div>
                            <label class="block text-primary-dark text-sm mb-1">Video Length</label>
                            <div class="px-3 py-2 rounded border border-neutral-dark bg-neutral-light">
                                <span x-text="formatTime(videoLength)"></span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-primary-dark text-sm mb-1">Video ID</label>
                            <div class="px-3 py-2 rounded border border-neutral-dark bg-neutral-light">
                                <span x-text="youtubeVideoId"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map Section -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-primary font-medium">Select Location</label>
                        <div x-show="latitude && longitude" class="text-sm text-primary-dark">
                            Coordinates: <span x-text="latitude"></span>, <span x-text="longitude"></span>
                        </div>
                    </div>

                    <!-- Location Search Box -->
                    <div class="mb-3">
                        <div class="flex">
                            <input
                                    id="location-search"
                                    type="text"
                                    x-model="locationSearchQuery"
                                    placeholder="Search for a location (e.g., city, landmark, address)"
                                    class="flex-grow px-4 py-2 rounded-l-md border border-neutral-dark bg-neutral focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                            <button
                                    type="button"
                                    @click="searchLocation()"
                                    class="px-4 py-2 bg-secondary hover:bg-secondary-dark text-primary-dark rounded-r-md border-t border-r border-b border-neutral-dark"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </button>
                        </div>
                        <div x-show="searchResults.length > 0" class="mt-2 bg-neutral-light border border-neutral-dark rounded-md overflow-hidden shadow-md">
                            <ul class="max-h-60 overflow-y-auto">
                                <template x-for="(result, index) in searchResults" :key="index">
                                    <li
                                            @click="selectSearchResult(result)"
                                            class="px-4 py-2 hover:bg-secondary cursor-pointer border-b border-neutral-dark last:border-b-0"
                                    >
                                        <p class="text-primary font-medium" x-text="result.name"></p>
                                        <p class="text-primary-dark text-sm" x-text="result.displayName"></p>
                                    </li>
                                </template>
                            </ul>
                        </div>
                        <p class="text-primary-dark text-sm mt-1" x-show="isSearching">
                            <svg class="inline animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Searching...
                        </p>
                        <p class="text-yellow-600 text-sm mt-1" x-show="searchError" x-text="searchError"></p>
                        <p class="text-primary-dark text-sm mt-1" x-show="searchResults.length === 0 && !isSearching && searchPerformed">No results found. Try a different search term.</p>
                    </div>

                    <div id="map-container" class="h-96 w-full rounded-lg border border-neutral-dark"></div>
                    <p class="text-red-500 text-sm mt-1" x-show="errors.location" x-text="errors.location"></p>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-neutral-dark">
                    <button
                            type="button"
                            @click="resetForm()"
                            class="px-6 py-2 bg-neutral-dark hover:bg-neutral-darker text-primary rounded-md transition-colors"
                    >
                        Reset
                    </button>
                    <button
                            type="submit"
                            class="px-6 py-2 bg-accent hover:bg-accent-dark text-primary-dark font-medium rounded-md transition-colors flex items-center"
                            :disabled="isSubmitting"
                            :class="{'opacity-50 cursor-not-allowed': isSubmitting}"
                    >
                        <svg x-show="isSubmitting" class="animate-spin -ml-1 mr-2 h-4 w-4 text-primary-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Save Round Template
                    </button>
                </div>
            </form>
        </div>

        <!-- Success Message -->
        <div
                x-show="showSuccess"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform translate-y-0"
                x-transition:leave-end="opacity-0 transform translate-y-2"
                class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-8 rounded shadow-md"
        >
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="font-medium">Round template created successfully!</p>
                    <p class="mt-1">The new template has been saved and is ready to use in games.</p>
                    <div class="mt-2">
                        <button
                                @click="resetForm(); showSuccess = false"
                                class="text-sm text-green-700 underline hover:text-green-900"
                        >
                            Add another template
                        </button>
                    </div>
                </div>
                <button @click="showSuccess = false" class="ml-auto text-green-700 hover:text-green-900">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Recently Added Templates -->
        <div class="mb-6">
            <h2 class="text-xl font-bold text-primary mb-3">Recently Added Templates</h2>
            <div class="bg-neutral-light rounded-lg border border-neutral-dark overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-neutral-dark">
                        <thead class="bg-primary text-neutral">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">YouTube ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Coordinates</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Start Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Length</th>
                            <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Created</th>
                        </tr>
                        </thead>
                        <tbody class="bg-neutral-light divide-y divide-neutral-dark">
                        <template x-for="template in recentTemplates" :key="template.id">
                            <tr class="hover:bg-neutral-lightest">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-16 bg-black rounded overflow-hidden">
                                            <img :src="'https://img.youtube.com/vi/' + template.youtubeVideoId + '/default.jpg'"
                                                 class="h-full w-full object-cover">
                                        </div>
                                        <div class="ml-3">
                                            <div class="text-sm font-medium text-primary" x-text="template.youtubeVideoId"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-primary" x-text="template.latitude + ', ' + template.longitude"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-primary" x-text="formatTime(template.startTime)"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-primary" x-text="formatTime(template.videoLength)"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-primary" x-text="formatDate(template.createdAt)"></div>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="recentTemplates.length === 0">
                            <td colspan="5" class="px-6 py-4 text-center text-primary-dark">
                                No templates found
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

</body>
</html>